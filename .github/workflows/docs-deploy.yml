name: Deploy Docs and Firmware to GitHub Pages

on:
  push:
    branches:
      - main # Set this to your default branch
    paths:
      - 'docs/**' # Trigger when docs folder is changed
      - 'apps/fabreader-firmware/**' # Trigger when firmware code is changed

  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: 'pages'
  cancel-in-progress: true

jobs:
  # Add a separate job to check GitHub Pages configuration
  check-pages:
    name: Check GitHub Pages Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Display GitHub Pages Info
        run: |
          echo "⚠️ Important: GitHub Pages must be enabled in repository settings"
          echo "Please check https://github.com/${GITHUB_REPOSITORY}/settings/pages"
          echo "Ensure that GitHub Pages source is set to 'GitHub Actions'"
          echo "This workflow will continue but may fail if Pages are not properly configured"

  build-firmware:
    name: Build Firmware
    needs: [check-pages]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.modified, 'apps/fabreader-firmware')
    outputs:
      build_success: ${{ steps.build.outputs.build_success }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO and tools
        run: |
          python -m pip install --upgrade pip
          pip install platformio esptool
          pio upgrade

      - name: Build firmware
        id: build
        working-directory: apps/fabreader-firmware
        run: |
          echo "Building firmware..."
          pio run -e fabreader

          # Check if build was successful
          if [ -f ".pio/build/fabreader/firmware.bin" ]; then
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "Build failed to produce firmware.bin"
            echo "build_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Create merged firmware
        working-directory: apps/fabreader-firmware
        run: |
          echo "Creating merged firmware for ESP Web Tools..."
          esptool.py --chip esp32c3 merge_bin \
            -o .pio/build/fabreader/merged-firmware.bin \
            --flash_mode dio \
            --flash_freq 40m \
            --flash_size 4MB \
            0x0 .pio/build/fabreader/bootloader.bin \
            0x8000 .pio/build/fabreader/partitions.bin \
            0x10000 .pio/build/fabreader/firmware.bin

      - name: Create manifest file
        working-directory: apps/fabreader-firmware
        run: |
          echo "Creating manifest file..."
          # Extract version from a file or set a default
          VERSION=$(date +"%Y.%m.%d")

          # Get the repository name from GitHub context
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          OWNER_NAME="${GITHUB_REPOSITORY%/*}"

          # Construct the firmware URL based on GitHub Pages - now in /firmware subdirectory
          FIRMWARE_URL="https://${OWNER_NAME}.github.io/${REPO_NAME}/firmware/merged-firmware.bin"

          cat > .pio/build/fabreader/manifest.json << EOF
          {
            "name": "Fabreader Firmware",
            "version": "$VERSION",
            "new_install_prompt_erase": true,
            "builds": [
              {
                "chipFamily": "ESP32-C3",
                "parts": [
                  { "path": "$FIRMWARE_URL", "offset": 0 }
                ]
              }
            ]
          }
          EOF

      - name: Create firmware installer page
        working-directory: apps/fabreader-firmware
        run: |
          cat > .pio/build/fabreader/index.html << EOL
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Fabreader Firmware</title>
            <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
            <style>
              body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; line-height: 1.5; padding: 2rem; max-width: 800px; margin: 0 auto; }
              h1 { color: #333; }
              .install-container { margin: 2rem 0; padding: 1.5rem; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; }
              .version { font-size: 0.9rem; color: #666; margin-bottom: 1rem; }
              pre { background: #f5f5f5; padding: 1rem; border-radius: 4px; overflow-x: auto; }
              .error-message { color: #e53935; padding: 1rem; border: 1px solid #f8d7da; background-color: #fff5f5; border-radius: 4px; display: none; }
              .not-supported { display: none; }
              .card { box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 8px; padding: 1.5rem; margin: 2rem 0; background: white; }
              .requirements { background-color: #f8f9fa; }
              .build-info { font-size: 0.8rem; color: #666; margin-top: 2rem; }
              .back-link { margin-bottom: 1rem; }
            </style>
          </head>
          <body>
            <div class="back-link"><a href="/">← Back to Documentation</a></div>
            
            <h1>Fabreader Firmware Installer</h1>
            <p>Use this page to install or update your Fabreader device firmware using ESP Web Tools.</p>
            
            <div class="card requirements">
              <h3>⚠️ Requirements</h3>
              <ul>
                <li>Chrome or Edge browser on desktop (Web Serial is not supported on mobile or Firefox)</li>
                <li>ESP32-C3 based Fabreader device</li>
                <li>USB connection to your computer</li>
              </ul>
            </div>
            
            <div class="error-message" id="error-message">
              <p><strong>Error:</strong> <span id="error-text"></span></p>
            </div>
            
            <div class="install-container">
              <div class="version">Latest version: <span id="firmware-version">Loading...</span></div>
              <esp-web-install-button manifest="./manifest.json"></esp-web-install-button>
              <p class="not-supported" id="browser-not-supported">Your browser doesn't support Web Serial. Please use Chrome or Edge browser.</p>
            </div>
            
            <div class="card">
              <h2>Installation Instructions</h2>
              <ol>
                <li>Connect your Fabreader device to your computer using a USB cable</li>
                <li>Click the "Install" button above</li>
                <li>Select your device from the list when prompted</li>
                <li>Wait for the installation to complete</li>
              </ol>
            </div>
            
            <div class="card">
              <h2>Manual Installation</h2>
              <p>If the web installer doesn't work, you can download the firmware file and flash it manually:</p>
              <ol>
                <li>Download the <a href="./merged-firmware.bin" download>firmware binary</a></li>
                <li>Install <a href="https://github.com/espressif/esptool" target="_blank">esptool</a></li>
                <li>Flash using: <code>esptool.py --chip esp32c3 --port [PORT] --baud 921600 write_flash 0x0 merged-firmware.bin</code></li>
              </ol>
            </div>
            
            <div class="build-info">
              <p>Build date: $(date)</p>
              <p>Repository: ${GITHUB_REPOSITORY}</p>
              <p>Commit: ${GITHUB_SHA}</p>
            </div>
            
            <script>
              // Check if browser supports Web Serial
              if (!('serial' in navigator)) {
                document.getElementById('browser-not-supported').style.display = 'block';
              }
              
              // Fetch the manifest to display the current version
              fetch('./manifest.json')
                .then(response => {
                  if (!response.ok) {
                    throw new Error('Could not load firmware manifest. Status: ' + response.status);
                  }
                  return response.json();
                })
                .then(data => {
                  document.getElementById('firmware-version').textContent = data.version;
                })
                .catch(error => {
                  document.getElementById('firmware-version').textContent = 'Not available';
                  document.getElementById('error-message').style.display = 'block';
                  document.getElementById('error-text').textContent = error.message;
                  console.error('Error:', error);
                });
            </script>
          </body>
          </html>
          EOL

      - name: Upload firmware artifacts
        if: success()
        uses: actions/upload-artifact@v4 # Upgraded from v3 to v4
        with:
          name: firmware-build
          path: |
            apps/fabreader-firmware/.pio/build/fabreader/merged-firmware.bin
            apps/fabreader-firmware/.pio/build/fabreader/manifest.json
            apps/fabreader-firmware/.pio/build/fabreader/index.html
          retention-days: 1

  deploy:
    name: Deploy to GitHub Pages
    needs: [check-pages, build-firmware]
    # Continue even if build-firmware is skipped
    if: always() && needs.check-pages.result == 'success' && (needs.build-firmware.result == 'success' || needs.build-firmware.result == 'skipped')
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Download firmware artifacts
        # Only try to download if the build-firmware job ran and was successful
        if: needs.build-firmware.result == 'success'
        uses: actions/download-artifact@v4 # Upgraded from v3 to v4
        with:
          name: firmware-build
          path: ./firmware-build

      - name: Prepare site directory
        run: |
          mkdir -p ./_site

          # Copy docs folder to site root
          if [ -d "./docs" ]; then
            cp -r ./docs/* ./_site/
          else
            # Create a minimal index.html if no docs exist
            mkdir -p ./_site
            cat > ./_site/index.html << EOL
            <!DOCTYPE html>
            <html>
            <head>
              <meta charset="utf-8">
              <title>Attraccess Documentation</title>
              <style>
                body { font-family: system-ui, sans-serif; line-height: 1.5; max-width: 800px; margin: 0 auto; padding: 2rem; }
              </style>
            </head>
            <body>
              <h1>Attraccess Documentation</h1>
              <p><a href="/firmware">Go to Firmware Installation</a></p>
            </body>
            </html>
            EOL
          fi

          # Create firmware directory
          mkdir -p ./_site/firmware

          # Copy firmware files if they exist
          if [ -d "./firmware-build" ]; then
            cp -f ./firmware-build/merged-firmware.bin ./_site/firmware/ || echo "No firmware binary found"
            cp -f ./firmware-build/manifest.json ./_site/firmware/ || echo "No manifest found"
            cp -f ./firmware-build/index.html ./_site/firmware/ || echo "No index found"
          else
            # Create a placeholder if no firmware files exist
            cat > ./_site/firmware/index.html << EOL
            <!DOCTYPE html>
            <html>
            <head>
              <meta charset="utf-8">
              <title>Firmware Not Available</title>
              <style>
                body { font-family: system-ui, sans-serif; line-height: 1.5; max-width: 800px; margin: 0 auto; padding: 2rem; }
              </style>
            </head>
            <body>
              <h1>Firmware Not Available</h1>
              <p>No firmware is currently available for installation.</p>
              <p><a href="/">Back to Documentation</a></p>
            </body>
            </html>
            EOL
          fi

          # Create _headers file with CORS configuration
          cat > ./_site/_headers << EOL
          /*
            Access-Control-Allow-Origin: *
            Access-Control-Allow-Methods: GET, OPTIONS
            Access-Control-Allow-Headers: Content-Type
          EOL

          # List contents for debugging
          echo "Contents of _site directory:"
          ls -la ./_site
          if [ -d "./_site/firmware" ]; then
            echo "Contents of _site/firmware directory:"
            ls -la ./_site/firmware
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 # Upgraded from v2 to v4
        continue-on-error: true # Continue even if deployment fails

      - name: Check deployment result
        if: steps.deployment.outcome != 'success'
        run: |
          echo "::warning::GitHub Pages deployment failed"
          echo "Make sure GitHub Pages is enabled at https://github.com/${GITHUB_REPOSITORY}/settings/pages"
          echo "Set the source to 'GitHub Actions' under 'Build and deployment' section"
          echo "The workflow will continue, but the deployment didn't succeed"
